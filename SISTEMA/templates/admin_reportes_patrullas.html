<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci√≥n | Reportes de Patrullas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <style>
        .truncate-text {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .expanded {
            -webkit-line-clamp: unset;
        }
        @media (max-width: 768px) {
            .desktop-table { display: none; }
            .mobile-cards { display: block; }
        }
        @media (min-width: 769px) {
            .desktop-table { display: table; }
            .mobile-cards { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-7xl mx-auto bg-white p-4 md:p-6 rounded-lg shadow-xl">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-red-700 mb-2">üö® Reportes de Inspecci√≥n de Patrullas</h1>
                <p class="text-gray-600 text-sm md:text-base">Visualizaci√≥n y gesti√≥n de reportes de c√°maras y patrullas</p>
            </div>
            <a href="{{ url_for('admin_dashboard') }}" class="mt-3 md:mt-0 text-indigo-600 hover:text-indigo-800 font-medium flex items-center">
                ‚Üê Volver al Dashboard
            </a>
        </div>

        {% if reportes_patrulla %}
        
        <!-- Estad√≠sticas R√°pidas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div class="text-blue-600 text-sm font-medium">Total Reportes</div>
                <div class="text-2xl font-bold text-blue-900">{{ reportes_patrulla|length }}</div>
            </div>
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                <div class="text-red-600 text-sm font-medium">Pendientes</div>
                <div class="text-2xl font-bold text-red-900">
                    {{ reportes_patrulla|selectattr('0.estado', 'equalto', 'Pendiente')|list|length }}
                </div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                <div class="text-yellow-600 text-sm font-medium">En Proceso</div>
                <div class="text-2xl font-bold text-yellow-900">
                    {{ reportes_patrulla|selectattr('0.estado', 'equalto', 'En Proceso')|list|length }}
                </div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <div class="text-green-600 text-sm font-medium">Cerrados</div>
                <div class="text-2xl font-bold text-green-900">
                    {{ reportes_patrulla|selectattr('0.estado', 'equalto', 'Cerrado')|list|length }}
                </div>
            </div>
        </div>

        <!-- Filtros y B√∫squeda -->
        <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- B√∫squeda -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Buscar</label>
                    <input type="text" id="searchInput" placeholder="Unidad, oficial..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 focus:border-transparent">
                </div>
                
                <!-- Filtro por Estado -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                    <select id="filterEstado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        <option value="">Todos</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="En Proceso">En Proceso</option>
                        <option value="Cerrado">Cerrado</option>
                    </select>
                </div>

                <!-- Filtro por Fecha -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                    <input type="date" id="filterFechaDesde" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                    <input type="date" id="filterFechaHasta" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 focus:border-transparent">
                </div>
            </div>
            
            <div class="mt-4 flex gap-2">
                <button onclick="aplicarFiltros()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                    üîç Filtrar
                </button>
                <button onclick="limpiarFiltros()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">
                    ‚úï Limpiar
                </button>
                <button onclick="exportarCSV()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition ml-auto">
                    üìä Exportar CSV
                </button>
            </div>
        </div>

        <!-- Tabla Desktop -->
        <div class="overflow-x-auto desktop-table">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-red-600 text-white">    
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider cursor-pointer hover:bg-red-700" onclick="ordenarPor('id')">
                            ID <span class="sort-indicator">‚Üï</span>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider cursor-pointer hover:bg-red-700" onclick="ordenarPor('unidad')">
                            Unidad <span class="sort-indicator">‚Üï</span>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                            Oficial
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider cursor-pointer hover:bg-red-700" onclick="ordenarPor('fecha')">
                            Fecha <span class="sort-indicator">‚Üï</span>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                            Descripci√≥n Fallas
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider cursor-pointer hover:bg-red-700" onclick="ordenarPor('estado')">
                            Estado <span class="sort-indicator">‚Üï</span>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                            Acciones
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="tableBody">
                    {% for reporte in reportes_patrulla %}
                    <tr class="hover:bg-red-50 transition" 
                        data-id="{{ reporte[0].id }}"
                        data-unidad="{{ reporte[0].unidad_numero }}"
                        data-oficial="{{ reporte[0].oficial_nombre }}"
                        data-fecha="{{ reporte[0].fecha_reporte.strftime('%Y-%m-%d') }}"
                        data-estado="{{ reporte[0].estado }}">
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            #{{ reporte[0].id }}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-semibold">
                                {{ reporte[0].unidad_numero }}
                            </span>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm">
                            <div class="font-medium text-gray-900">{{ reporte[0].oficial_nombre }}</div>
                            <div class="text-gray-500 text-xs">@{{ reporte[1].username }}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">
                            <div>{{ reporte[0].fecha_reporte.strftime('%d/%m/%Y') }}</div>
                            <div class="text-xs text-gray-400">{{ reporte[0].fecha_reporte.strftime('%H:%M') }}</div>
                        </td>
                        <td class="px-4 py-4 text-sm max-w-xs">
                            {% if reporte[0].falla_descripcion %}
                                <div class="truncate-text" id="desc-{{ reporte[0].id }}">
                                    {{ reporte[0].falla_descripcion }}
                                </div>
                                <button onclick="toggleDescripcion-({{reporte[0].id}})" 
                                        class="text-red-600 hover:text-red-800 text-xs mt-1 font-medium">
                                    Ver m√°s ‚Üì
                                </button>
                            {% else %}
                                <span class="text-gray-400 italic">Sin descripci√≥n</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <select onchange="cambiarEstado({{reporte[0].id}},this.value)" 
                                    class="px-2 py-1 text-xs leading-5 font-semibold rounded-full border-0 cursor-pointer
                                    {% if reporte[0].estado == 'En Proceso' %} bg-yellow-100 text-yellow-800
                                    {% elif reporte[0].estado == 'Cerrado' %} bg-green-100 text-green-800
                                    {% else %} bg-red-100 text-red-800 {% endif %}">
                                <option value="Pendiente" {% if reporte[0].estado == 'Pendiente' %}selected{% endif %}>‚è≥ Pendiente</option>
                                <option value="En Proceso" {% if reporte[0].estado == 'En Proceso' %}selected{% endif %}>üîß En Proceso</option>
                                <option value="Cerrado" {% if reporte[0].estado == 'Cerrado' %}selected{% endif %}>‚úÖ Cerrado</option>
                            </select>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm">
                            <div class="flex gap-2">
                                <a href="{{ url_for('editar_reporte_patrulla', reporte_id=reporte[0].id) }}" 
                                   class="text-red-600 hover:text-red-900 font-medium" title="Ver detalle">
                                    üëÅÔ∏è Ver
                                </a>
                                <button onclick="confirmarEliminar({{ reporte[0].id }})" 
                                        class="text-gray-600 hover:text-gray-900" title="Eliminar">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Vista Mobile (Tarjetas) -->
        <div class="mobile-cards space-y-4" id="mobileCards">
            {% for reporte in reportes_patrulla %}
            <div class="border border-gray-200 rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition"
                 data-id="{{ reporte[0].id }}"
                 data-unidad="{{ reporte[0].unidad_numero }}"
                 data-oficial="{{ reporte[0].oficial_nombre }}"
                 data-fecha="{{ reporte[0].fecha_reporte.strftime('%Y-%m-%d') }}"
                 data-estado="{{ reporte[0].estado }}">
                
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <span class="text-xs text-gray-500">ID #{{ reporte[0].id }}</span>
                        <div class="font-bold text-lg text-red-700">{{ reporte[0].unidad_numero }}</div>
                    </div>
                    <span class="px-2 py-1 text-xs font-semibold rounded-full
                        {% if reporte[0].estado == 'En Proceso' %} bg-yellow-100 text-yellow-800
                        {% elif reporte[0].estado == 'Cerrado' %} bg-green-100 text-green-800
                        {% else %} bg-red-100 text-red-800 {% endif %}">
                        {{ reporte[0].estado }}
                    </span>
                </div>

                <div class="text-sm mb-2">
                    <span class="font-medium">Oficial:</span> {{ reporte[0].oficial_nombre }}
                </div>
                <div class="text-sm text-gray-600 mb-3">
                    üìÖ {{ reporte[0].fecha_reporte.strftime('%d/%m/%Y %H:%M') }}
                </div>

                {% if reporte[0].falla_descripcion %}
                <div class="text-sm text-gray-700 mb-3 p-2 bg-gray-50 rounded">
                    {{ reporte[0].falla_descripcion[:100] }}{% if reporte[0].falla_descripcion|length > 100 %}...{% endif %}
                </div>
                {% endif %}

                <div class="flex gap-2">
                    <a href="{{ url_for('editar_reporte_patrulla', reporte_id=reporte[0].id) }}" 
                       class="flex-1 text-center px-3 py-2 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700">
                        Ver Detalle
                    </a>
                    <button onclick="confirmarEliminar({{ reporte[0].id }})" 
                            class="px-3 py-2 bg-gray-200 text-gray-700 rounded-md text-sm hover:bg-gray-300">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Paginaci√≥n -->
        <div class="mt-6 flex justify-between items-center">
            <div class="text-sm text-gray-600">
                Mostrando <span id="resultadosCount">{{ reportes_patrulla|length }}</span> de {{ reportes_patrulla|length }} reportes
            </div>
            <div class="flex gap-2">
                <button class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50" disabled>
                    ‚Üê Anterior
                </button>
                <button class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50" disabled>
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        {% else %}
        <div class="text-center py-12">
            <div class="text-6xl mb-4">üìã</div>
            <p class="text-gray-500 text-lg">No hay reportes de patrullas registrados a√∫n.</p>
        </div>
        {% endif %}
    </div>

    <script>
        // Toggle descripci√≥n expandida
        function toggleDescripcion(id) {
            const elemento = document.getElementById(`desc-${id}`);
            const boton = elemento.nextElementSibling;
            
            if (elemento.classList.contains('expanded')) {
                elemento.classList.remove('expanded');
                boton.textContent = 'Ver m√°s ‚Üì';
            } else {
                elemento.classList.add('expanded');
                boton.textContent = 'Ver menos ‚Üë';
            }
        }

        // Cambiar estado del reporte
        function cambiarEstado(id, nuevoEstado) {
            if (confirm(`¬øCambiar estado del reporte #${id} a "${nuevoEstado}"?`)) {
                // Aqu√≠ ir√≠a la llamada AJAX al servidor
                fetch(`/api/reportes/${id}/estado`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({estado: nuevoEstado})
                })
                .then(res => res.json())
                .then(data => {
                    alert('Estado actualizado correctamente');
                    location.reload();
                })
                .catch(err => alert('Error al actualizar estado'));
            }
        }

        // Confirmar eliminaci√≥n
        function confirmarEliminar(id) {
            if (confirm(`¬øEst√°s seguro de eliminar el reporte #${id}? Esta acci√≥n no se puede deshacer.`)) {
                // Llamada AJAX para eliminar
                fetch(`/api/reportes/${id}`, {
                    method: 'DELETE'
                })
                .then(res => res.json())
                .then(data => {
                    alert('Reporte eliminado correctamente');
                    location.reload();
                })
                .catch(err => alert('Error al eliminar reporte'));
            }
        }

        // Aplicar filtros
        function aplicarFiltros() {
            const busqueda = document.getElementById('searchInput').value.toLowerCase();
            const estado = document.getElementById('filterEstado').value;
            const fechaDesde = document.getElementById('filterFechaDesde').value;
            const fechaHasta = document.getElementById('filterFechaHasta').value;

            const filas = document.querySelectorAll('#tableBody tr, #mobileCards > div');
            let visible = 0;
            

            filas.forEach(fila => {
                const unidad = fila.dataset.unidad.toLowerCase();
                const oficial = fila.dataset.oficial.toLowerCase();
                const fechaReporte = fila.dataset.fecha;
                const estadoReporte = fila.dataset.estado;

                let mostrar = true;

                // Filtro de b√∫squeda
                if (busqueda && !unidad.includes(busqueda) && !oficial.includes(busqueda)) {
                    mostrar = false;
                }

                // Filtro de estado
                if (estado && estadoReporte !== estado) {
                    mostrar = false;
                }

                // Filtro de fecha
                if (fechaDesde && fechaReporte < fechaDesde) {
                    mostrar = false;
                }
                if (fechaHasta && fechaReporte > fechaHasta) {
                    mostrar = false;
                }

                fila.style.display = mostrar ? '' : 'none';
                if (mostrar) visible++;
            });

            document.getElementById('resultadosCount').textContent = visible;
        }

        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterEstado').value = '';
            document.getElementById('filterFechaDesde').value = '';
            document.getElementById('filterFechaHasta').value = '';
            aplicarFiltros();
        }

        // Ordenar por columna
        let ordenActual = {columna: null, direccion: 'asc'};

        function ordenarPor(columna) {
            const tbody = document.getElementById('tableBody');
            const filas = Array.from(tbody.querySelectorAll('tr'));

            if (ordenActual.columna === columna) {
                ordenActual.direccion = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
            } else {
                ordenActual.columna = columna;
                ordenActual.direccion = 'asc';
            }

            filas.sort((a, b) => {
                let valorA, valorB;

                switch(columna) {
                    case 'id':
                        valorA = parseInt(a.dataset.id);
                        valorB = parseInt(b.dataset.id);
                        break;
                    case 'unidad':
                        valorA = a.dataset.unidad;
                        valorB = b.dataset.unidad;
                        break;
                    case 'fecha':
                        valorA = new Date(a.dataset.fecha);
                        valorB = new Date(b.dataset.fecha);
                        break;
                    case 'estado':
                        valorA = a.dataset.estado;
                        valorB = b.dataset.estado;
                        break;
                }

                if (valorA < valorB) return ordenActual.direccion === 'asc' ? -1 : 1;
                if (valorA > valorB) return ordenActual.direccion === 'asc' ? 1 : -1;
                return 0;
            });

            filas.forEach(fila => tbody.appendChild(fila));
        }

        // Exportar a CSV
        function exportarCSV() {
            const filas = document.querySelectorAll('#tableBody tr');
            let csv = 'ID,Unidad,Oficial,Fecha,Estado,Descripci√≥n\n';

            filas.forEach(fila => {
                if (fila.style.display !== 'none') {
                    const celdas = fila.querySelectorAll('td');
                    const datos = [
                        fila.dataset.id,
                        fila.dataset.unidad,
                        fila.dataset.oficial,
                        fila.dataset.fecha,
                        fila.dataset.estado,
                        celdas[4].textContent.replace(/\n/g, ' ').replace(/,/g, ';')
                    ];
                    csv += datos.join(',') + '\n';
                }
            });

            const blob = new Blob([csv], {type: 'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reportes_patrullas_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Aplicar filtros en tiempo real al buscar
        document.getElementById('searchInput')?.addEventListener('input', aplicarFiltros);
    </script>
</body>
</html>